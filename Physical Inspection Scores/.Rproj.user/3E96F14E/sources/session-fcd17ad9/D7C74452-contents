library(tidyverse)
library(ggplot2)
library(gtsummary)
library(survival)
library(survminer)


# read in data
pat_dx = read.csv("Patient_Diagnosis_(2).csv")
pat_txt = read.csv("Patient_Treatment_(2).csv")


#Data analysis questions
# 1. First, the clinic would like to know the distribution of cancer types across their patients.
# Please provide the clinic with this information. Note that patients can be diagnosed with
# more than one cancer.

# get the counts of diagnoses for each patient, remove duplicates
tbl1 = list(
pat_dx %>% 
  mutate(check = paste(patient_id,diagnosis)) %>% 
  filter(!duplicated(check)) %>% 
  select(diagnosis) %>% 
  tbl_summary(label = diagnosis ~ "Aggregate Diagnosis Count") %>% 
  modify_header(label = "") %>% 
  bold_labels() %>% 
  add_n(),
# get first diagnoses
pat_dx %>% 
  mutate(diagnosis_date = diagnosis_date %>% lubridate::mdy()) %>% 
  group_by(patient_id) %>% 
  arrange(desc(diagnosis_date)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(diagnosis) %>% 
  tbl_summary(label = diagnosis ~ "First Diagnosis") %>% 
  bold_labels() %>% 
  modify_header(label = "") %>% 
  add_n()) %>% 
  tbl_stack() %>% 
  modify_header(stat_0 = "**Count**")



# 2. The clinic wants to know how long it takes for patients to start therapy after being
# diagnosed, which they consider to be helpful in understanding the quality of care for the
# patient. How long after being diagnosed do patients start treatment?
  
# arrange the dates so they are the earliest dates, make into a data frame
first_dx_txt_df = merge(pat_dx %>% 
  mutate(diagnosis_date = diagnosis_date %>% lubridate::mdy()) %>% 
  group_by(patient_id) %>% 
  arrange(diagnosis_date)  %>% 
  slice(1),
pat_txt %>% 
  mutate(treatment_date = treatment_date %>% lubridate::mdy()) %>% 
  group_by(patient_id) %>% 
  arrange(treatment_date) %>% 
  slice(1),
by = "patient_id",all.x = T) %>% 
  mutate(tte = difftime(treatment_date,diagnosis_date,units = "days") %>% as.numeric())

# look at the median and mean time, remove negative times
tbl2 = first_dx_txt_df %>%
  filter(tte >= 0) %>% 
  select(tte) %>% 
  tbl_summary(label = tte ~ "Time to First Treatment From First Diagnosis (Days)",
              type = everything() ~ "continuous2",
              statistic = all_continuous() ~ c("{mean} ({sd})",
                                               "{median} ({p25}, {p75})",
                                               "{min}, {max}")) %>% 
  bold_labels() %>% 
  modify_header(label = "")
  
  

# 3. Which treatment regimens [i.e., drug(s)] do you think would be indicated to be used as
# first-line of treatment for breast cancer? What about colon cancer? (For more information
#                                                                     on first-line and second-line treatments, click here. Additionally, note that some patients
#                                                                      may receive more than one drug as part of their first-line treatment, i.e., combination
#                                                                      therapy)

tbl3 = first_dx_txt_df %>% 
  filter(tte>=0) %>% 
  select(diagnosis,drug_code) %>% 
  tbl_summary(by = diagnosis,
              label = drug_code ~ "Treatment") %>% 
  add_p() %>% 
  bold_labels() %>% 
  modify_header(label = "")
# looks like A and B are associated more with Breast Cancer, C and D for Colon


# 4. Do the patients taking Drug A monotherapy vs. Drug B monotherapy as first-line therapy
# for breast cancer vary in terms of duration of therapy? Please include statistical tests and
# visualizations, as appropriate
survival_data = first_dx_txt_df %>% 
  filter(tte>=0) %>%
  filter(grepl("A|B",drug_code)) %>% 
  mutate(s = 1) 

fig1 = survfit(Surv(tte,s) ~ Drug,data =survival_data %>% 
          dplyr::rename(Drug = drug_code)) %>% 
  ggsurvplot(xlim = c(0,100),break.x.by = 25,
             fun = function(x)1-x,pval = T,
             ggtheme = ggthemes::theme_clean(),
             legend.title = ""
             )+
  labs(y = "Cumulative Incidence",
       x = "Time (Days)")
  # the p-value is coming from the log rank test

# Below is a table to accompany it
save.image("FHTest.RData")


